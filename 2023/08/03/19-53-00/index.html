<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/good_16x16.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/good_16x16.png">
  <link rel="mask-icon" href="/images/good.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shiquheng.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="摘要本文记录了一个Springboot + shiro的权限管理项目的基本实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="Springboot-shiro权限管理项目">
<meta property="og:url" content="https://shiquheng.github.io/2023/08/03/19-53-00/index.html">
<meta property="og:site_name" content="Liuzhihua">
<meta property="og:description" content="摘要本文记录了一个Springboot + shiro的权限管理项目的基本实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://shiquheng.github.io/pic/2023-08-04-20-47-24.png">
<meta property="article:published_time" content="2023-08-03T11:53:00.000Z">
<meta property="article:modified_time" content="2023-08-09T03:35:56.359Z">
<meta property="article:author" content="LiuZhihua">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Springboot">
<meta property="article:tag" content="Shiro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://shiquheng.github.io/pic/2023-08-04-20-47-24.png">


<link rel="canonical" href="https://shiquheng.github.io/2023/08/03/19-53-00/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://shiquheng.github.io/2023/08/03/19-53-00/","path":"2023/08/03/19-53-00/","title":"Springboot-shiro权限管理项目"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Springboot-shiro权限管理项目 | Liuzhihua</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>
  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Liuzhihua</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">永远不要随波逐流</p>
      <img class="custom-logo-image" src="/uploads/liuzhihua_logo.png" alt="Liuzhihua">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">58</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">15</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">53</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EShiro"><span class="nav-number">1.</span> <span class="nav-text">关于Shiro</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="nav-number">2.</span> <span class="nav-text">学习目标</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">表结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81"><span class="nav-number">4.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MD5%E7%AE%97%E6%B3%95%E8%BF%87%E7%A8%8B"><span class="nav-number">4.1.</span> <span class="nav-text">MD5算法过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%88%E6%9D%83"><span class="nav-number">5.</span> <span class="nav-text">授权</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="nav-number">6.</span> <span class="nav-text">会话管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#session%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.1.</span> <span class="nav-text">session实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RememberMe-Cookie"><span class="nav-number">6.2.</span> <span class="nav-text">RememberMe Cookie</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%89%E9%92%AE%E6%8E%A7%E5%88%B6"><span class="nav-number">7.</span> <span class="nav-text">按钮控制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="nav-number">8.</span> <span class="nav-text">添加依赖</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0shiro%E9%85%8D%E7%BD%AE"><span class="nav-number">9.</span> <span class="nav-text">添加shiro配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Realm%E5%AE%9E%E7%8E%B0"><span class="nav-number">10.</span> <span class="nav-text">Realm实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81"><span class="nav-number">11.</span> <span class="nav-text">自定义表单验证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#web%E7%9B%B8%E5%85%B3"><span class="nav-number">12.</span> <span class="nav-text">web相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="nav-number">12.1.</span> <span class="nav-text">登录页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#controller"><span class="nav-number">12.1.1.</span> <span class="nav-text">controller</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#login-html"><span class="nav-number">12.1.2.</span> <span class="nav-text">login.html</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E9%A1%B5%E9%9D%A2"><span class="nav-number">12.2.</span> <span class="nav-text">主页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#controller-1"><span class="nav-number">12.2.1.</span> <span class="nav-text">controller</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#index-html"><span class="nav-number">12.2.2.</span> <span class="nav-text">index.html</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">13.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90%E6%B5%8B%E8%AF%95"><span class="nav-number">13.1.</span> <span class="nav-text">登录页面权限测试</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiuZhihua</p>
  <div class="site-description" itemprop="description">个人博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ShiQuheng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ShiQuheng" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/liuzhihua0415@foxmail.com" title="E-Mail → liuzhihua0415@foxmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shiquheng.github.io/2023/08/03/19-53-00/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiuZhihua">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Liuzhihua">
      <meta itemprop="description" content="个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Springboot-shiro权限管理项目 | Liuzhihua">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Springboot-shiro权限管理项目
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-08-03 19:53:00" itemprop="dateCreated datePublished" datetime="2023-08-03T19:53:00+08:00">2023-08-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-08-09 11:35:56" itemprop="dateModified" datetime="2023-08-09T11:35:56+08:00">2023-08-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><strong>摘要</strong><br>本文记录了一个Springboot + shiro的权限管理项目的基本实现。 </p>
<span id="more"></span>
<h1 id="关于Shiro"><a href="#关于Shiro" class="headerlink" title="关于Shiro"></a>关于Shiro</h1><p>shiro的核心：  </p>
<ul>
<li>**Subject(主体)**： 用于记录当前的操作用户，<code>Subject</code>在shiro中是一个接口，接口中定义了很多认证授权相关的方法，外部程序通过<code>subject</code>进行认证授权，而<code>subject</code>是通过SecurityManager安全管理器进行认证授权。</li>
<li>**SecurityManager(安全管理器)**：对<code>Subject</code>进行管理，他是shiro的核心。<code>SecurityManager</code>是一个接口，继承了<code>Authenticator</code>, <code>Authorizer</code>, <code>SessionManager</code>这三个接口。<ul>
<li>**Authenticator(认证器)**：对用户身份进行认证。</li>
<li>**Authorizer(授权器)**：用户通过认证后，来判断时候拥有该权限。</li>
<li>**sessionManager(会话管理)**：shiro框架定义了一套会话管理，它不依赖web容器的session，所以shiro可以使用在非web应用上，也可以将分布式应用的会话集中在一点管理，此特性可使它实现单点登录。</li>
</ul>
</li>
<li>realm：获取用户权限数据。</li>
<li>CacheManager(缓存管理器)：将用户权限数据存储在缓存，这样可以提高性能。</li>
</ul>
<h1 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h1><p>实现基于数据库的细粒度动态权限管理系统实例。 </p>
<p>RBAC role based access control 访问控制基于角色，安全管理的实现思路就是前台通过相关的标签进行标记，后台通过拦截器将资源拦截，用户关联的是角色role，role关联的是权限和资源，通过资源和权限关联最终的效果。</p>
<h1 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h1><p>用标准的5张表来展示权限，分别为用户表，角色表，资源表，用户角色表，角色资源表  </p>
<p><img src="/../pic/2023-08-04-20-47-24.png" alt="表结构">  </p>
<h1 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h1><p>认证就是验证用户。比如用户登录的时候验证账号密码是否正确。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value=&quot;/login&quot;,method=RequestMethod.POST)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(HttpServletRequest request, User user, Model model)</span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (StringUtils.isEmpty(user.getUsername()) || StringUtils.isEmpty(user.getPassword())) &#123;</span><br><span class="line">           request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;用户名或密码不能为空！&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">       UsernamePasswordToken token=<span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(user.getUsername(),user.getPassword());</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           subject.login(token);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;redirect:usersPage&quot;</span>;</span><br><span class="line">       &#125;<span class="keyword">catch</span> (LockedAccountException lae) &#123;</span><br><span class="line">           token.clear();</span><br><span class="line">           request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;用户已经被锁定不能登录，请与管理员联系！&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">           token.clear();</span><br><span class="line">           request.setAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;用户或密码不正确！&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>用户登陆的代码主要就是 <code>subject.login(token);</code>调用后就会进去我们自定义的realm中的<code>doGetAuthenticationInfo()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//认证</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">       <span class="comment">//获取用户的输入的账号.</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String)token.getPrincipal();</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.selectByUsername(username);</span><br><span class="line">       <span class="keyword">if</span>(user==<span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownAccountException</span>();</span><br><span class="line">       <span class="keyword">if</span> (<span class="number">0</span>==user.getEnable()) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LockedAccountException</span>(); <span class="comment">// 帐号锁定</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="type">SimpleAuthenticationInfo</span> <span class="variable">authenticationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(</span><br><span class="line">               user, <span class="comment">//用户</span></span><br><span class="line">               user.getPassword(), <span class="comment">//密码</span></span><br><span class="line">               ByteSource.Util.bytes(username),</span><br><span class="line">               getName()  <span class="comment">//realm name</span></span><br><span class="line">       );</span><br><span class="line">       <span class="comment">// 当验证都通过后，把用户信息放在session里</span></span><br><span class="line">       <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> SecurityUtils.getSubject().getSession();</span><br><span class="line">       session.setAttribute(<span class="string">&quot;userSession&quot;</span>, user);</span><br><span class="line">       session.setAttribute(<span class="string">&quot;userSessionId&quot;</span>, user.getId());</span><br><span class="line">       <span class="keyword">return</span> authenticationInfo;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>从token中获取用户名，再根据用户名从数据库中查询用户，如果为空或者不可用则抛出异常，否则进行密码的验证。<br>为了防止用户登录密码泄露，数据库存储的密码不能是明文，即使数据库泄露了密码也不能直接泄露。通常的做法是将用户设置的登录密码进行MD5运算&#x2F;加密后存入数据库。</p>
<p>当用户登录时，对用户输入的密码进行多次散列运算(MD5加盐运算)，盐值为由usename字符串转换的字节数据，运算结果与数据库中的值进行比对，如果MD5密文一样，则认为用户登录密码正确，反之则认为密码错误。</p>
<p><strong>注意：</strong>多次散列不等于多次md5(md5(…))，shiro中一次散列生成一个128位的结果，多次散列是将每次生成的128位结果再作为输入得到一个新的128位结果，最后将最新的128位结果转化为16进制的32个字符。而多次md5是将128位的结果转化为32个字符再作为输入，再进行md5运算，区别在于中间过程的输入不同，结果自然也就不同。因此在进行比对时，要注意使用相同的加密方式，这个项目中使用shiro提供的多次散列方式。同时，在增加用户时也要使用相同的加密方式。  </p>
<p>添加用户代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">add</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> userService.selectByUsername(user.getUsername());</span><br><span class="line">        <span class="keyword">if</span>(u != <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            user.setEnable(<span class="number">1</span>);</span><br><span class="line">            <span class="type">PasswordHelper</span> <span class="variable">passwordHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PasswordHelper</span>();</span><br><span class="line">            passwordHelper.encryptPassword(user);</span><br><span class="line">            userService.save(user);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>PasswordHelper：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.study.util;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.study.model.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.RandomNumberGenerator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.SecureRandomNumberGenerator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PasswordHelper</span> &#123;</span><br><span class="line">    <span class="comment">//private RandomNumberGenerator randomNumberGenerator = new SecureRandomNumberGenerator();</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">algorithmName</span> <span class="operator">=</span> <span class="string">&quot;md5&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">hashIterations</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encryptPassword</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="comment">//String salt=randomNumberGenerator.nextBytes().toHex();</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newPassword</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleHash</span>(algorithmName, user.getPassword(),  ByteSource.Util.bytes(user.getUsername()), hashIterations).toHex();</span><br><span class="line">        <span class="comment">//String newPassword = new SimpleHash(algorithmName, user.getPassword()).toHex();</span></span><br><span class="line">        user.setPassword(newPassword);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">PasswordHelper</span> <span class="variable">passwordHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PasswordHelper</span>();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            user.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        passwordHelper.encryptPassword(user);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="MD5算法过程"><a href="#MD5算法过程" class="headerlink" title="MD5算法过程"></a>MD5算法过程</h2><p>简要概述：将输入信息分组，每组512位，而每一分组又被划分为16个32位子分组，经过了一系列循环运算的处理后，算法的输出由四个32位分组组成，将这四个32位分组级联后将生成一个128位散列值。</p>
<p><strong>第一步:填充</strong><br>如果输入信息的长度(bit)对512求余的结果不等于448，就需要填充使得对512求余的结果等于448。填充的方法是填充一个1和n个0。填充完后，信息的长度就为N*512+448(bit)。<br><strong>第二步：记录信息长度</strong><br>用64位来存储填充前信息长度。这64位加在第一步结果的后面，这样信息长度就变为N512+448+64&#x3D;(N+1)512位。<br><strong>第三步：装入标准的幻数（四个整数）</strong><br>标准的幻数（物理顺序）是（A&#x3D;(01234567)16，B&#x3D;(89ABCDEF)16，C&#x3D;(FEDCBA98)16，D&#x3D;(76543210)16）。如果在程序中定义应该是: （A&#x3D;0X67452301L，B&#x3D;0XEFCDAB89L，C&#x3D;0X98BADCFEL，D&#x3D;0X10325476L）。有点晕哈，其实想一想就明白了。<br><strong>第四步：四轮循环运算</strong><br>循环的次数是分组的个数（N+1）<br>将每一512位细分成16个小组，每个小组32位（8个字节），再用四个非线性函数进行四轮运算，将运算的结果加到下一个分组的数上，继续循环四轮计算，直到循环N+1次结束，得到四个结果，级联组成128位，得到总结果，用16进制表示得到32个字符。  </p>
<h1 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h1><p>在自定义relalm中的代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//授权</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> &#123;</span><br><span class="line">       User user= (User) SecurityUtils.getSubject().getPrincipal();<span class="comment">//User&#123;id=1, username=&#x27;admin&#x27;, password=&#x27;3ef7164d1f6167cb9f2658c07d3c2f0a&#x27;, enable=1&#125;</span></span><br><span class="line">       Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,Object&gt;();</span><br><span class="line">       map.put(<span class="string">&quot;userid&quot;</span>,user.getId());</span><br><span class="line">       List&lt;Resources&gt; resourcesList = resourcesService.loadUserResources(map);</span><br><span class="line">       <span class="comment">// 权限信息对象info,用来存放查出的用户的所有的角色（role）及权限（permission）</span></span><br><span class="line">       <span class="type">SimpleAuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">       <span class="keyword">for</span>(Resources resources: resourcesList)&#123;</span><br><span class="line">           info.addStringPermission(resources.getResurl());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> info;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>从以上代码中可以看出来，我根据用户id查询出用户的权限，放入<code>SimpleAuthorizationInfo</code>。关联表<code>user_role</code>，<code>role_resources</code>，<code>resources</code>，三张表，根据用户所拥有的角色，角色所拥有的权限，查询出分配给该用户的所有权限的url。当访问的链接中配置在shiro中时，或者使用shiro标签，shiro权限注解时，则会访问该方法，判断该用户是否拥有相应的权限。</p>
<p>在ShiroConfig中有如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shirFilter</span><span class="params">(SecurityManager securityManager)</span>&#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;ShiroConfiguration.shirFilter()&quot;</span>);</span><br><span class="line">       <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 必须设置 SecurityManager</span></span><br><span class="line">       shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">       <span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的&quot;/login.jsp&quot;页面</span></span><br><span class="line">       shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">       <span class="comment">// 登录成功后要跳转的链接</span></span><br><span class="line">       shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/usersPage&quot;</span>);</span><br><span class="line">       <span class="comment">//未授权界面;</span></span><br><span class="line">       shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/403&quot;</span>);</span><br><span class="line">       <span class="comment">//拦截器.</span></span><br><span class="line">       Map&lt;String,String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String,String&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//配置退出 过滤器,其中的具体的退出代码Shiro已经替我们实现了</span></span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/js/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/font-awesome/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">       <span class="comment">//&lt;!-- 过滤链定义，从上向下顺序执行，一般将 /**放在最为下边 --&gt;:这是一个坑呢，一不小心代码就不好使了;</span></span><br><span class="line">       <span class="comment">//&lt;!-- authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问--&gt;</span></span><br><span class="line">       <span class="comment">//自定义加载权限资源关系</span></span><br><span class="line">       List&lt;Resources&gt; resourcesList = resourcesService.queryAll();</span><br><span class="line">        <span class="keyword">for</span>(Resources resources:resourcesList)&#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (StringUtil.isNotEmpty(resources.getResurl())) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">permission</span> <span class="operator">=</span> <span class="string">&quot;perms[&quot;</span> + resources.getResurl()+ <span class="string">&quot;]&quot;</span>;</span><br><span class="line">               filterChainDefinitionMap.put(resources.getResurl(),permission);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">       <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>该代码片段为配置shiro的过滤器。以上代码将静态文件设置为任何权限都可访问，然后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Resources&gt; resourcesList = resourcesService.queryAll();</span><br><span class="line">        <span class="keyword">for</span>(Resources resources:resourcesList)&#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (StringUtil.isNotEmpty(resources.getResurl())) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">permission</span> <span class="operator">=</span> <span class="string">&quot;perms[&quot;</span> + resources.getResurl()+ <span class="string">&quot;]&quot;</span>;</span><br><span class="line">               filterChainDefinitionMap.put(resources.getResurl(),permission);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p><strong>在数据中查询所有的资源，将该资源的url当作key，配置拥有该url权限的用户才可访问该url。</strong><br>最后加入 <code>filterChainDefinitionMap.put(“/*”, “authc”);</code>表示其他没有配置的链接都需要认证才可访问。注意这个要放最后面，因为shiro的匹配是从上往下，如果匹配到就不继续匹配了，所以如果把<code>/*</code>放到最前面，则后面的链接都无法匹配到了。  </p>
<p>而这段代码是在项目启动的时候加载的。加载的数据是放到内存中的。但是当权限增加或者删除时，正常情况下不会重新启动来，重新加载权限。所以需要调用以下代码的<code>updatePermission()</code>方法来重新加载权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.study.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.util.StringUtil;</span><br><span class="line"><span class="keyword">import</span> com.study.model.Resources;</span><br><span class="line"><span class="keyword">import</span> com.study.model.User;</span><br><span class="line"><span class="keyword">import</span> com.study.service.ResourcesService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.RealmSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.SimplePrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.support.DefaultSubjectContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.DefaultFilterChainManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.AbstractShiroFilter;</span><br><span class="line"><span class="keyword">import</span> org.crazycake.shiro.RedisSessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShiroFilterFactoryBean shiroFilterFactoryBean;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourcesService resourcesService;</span><br><span class="line">  <span class="comment">/*  @Autowired</span></span><br><span class="line"><span class="comment">    private RedisSessionDAO redisSessionDAO;*/</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">loadFilterChainDefinitions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 权限控制map.从数据库获取</span></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/js/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/font-awesome/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        List&lt;Resources&gt; resourcesList = resourcesService.queryAll();</span><br><span class="line">        <span class="keyword">for</span>(Resources resources:resourcesList)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StringUtil.isNotEmpty(resources.getResurl())) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">permission</span> <span class="operator">=</span> <span class="string">&quot;perms[&quot;</span> + resources.getResurl()+ <span class="string">&quot;]&quot;</span>;</span><br><span class="line">                filterChainDefinitionMap.put(resources.getResurl(),permission);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> filterChainDefinitionMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重新加载权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updatePermission</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (shiroFilterFactoryBean) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">AbstractShiroFilter</span> <span class="variable">shiroFilter</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                shiroFilter = (AbstractShiroFilter) shiroFilterFactoryBean</span><br><span class="line">                        .getObject();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                        <span class="string">&quot;get ShiroFilter from shiroFilterFactoryBean error!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">PathMatchingFilterChainResolver</span> <span class="variable">filterChainResolver</span> <span class="operator">=</span> (PathMatchingFilterChainResolver) shiroFilter</span><br><span class="line">                    .getFilterChainResolver();</span><br><span class="line">            <span class="type">DefaultFilterChainManager</span> <span class="variable">manager</span> <span class="operator">=</span> (DefaultFilterChainManager) filterChainResolver</span><br><span class="line">                    .getFilterChainManager();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清空老的权限控制</span></span><br><span class="line">            manager.getFilterChains().clear();</span><br><span class="line"></span><br><span class="line">            shiroFilterFactoryBean.getFilterChainDefinitionMap().clear();</span><br><span class="line">            shiroFilterFactoryBean</span><br><span class="line">                    .setFilterChainDefinitionMap(loadFilterChainDefinitions());</span><br><span class="line">            <span class="comment">// 重新构建生成</span></span><br><span class="line">            Map&lt;String, String&gt; chains = shiroFilterFactoryBean</span><br><span class="line">                    .getFilterChainDefinitionMap();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : chains.entrySet()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                <span class="type">String</span> <span class="variable">chainDefinition</span> <span class="operator">=</span> entry.getValue().trim()</span><br><span class="line">                        .replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                manager.createChain(url, chainDefinition);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;更新权限成功！！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h1><p>shiro提供的session不依赖web容器，可以直接使用，如果是在web环境下，session中的数据和httpsession中的数据是通的。Shiro中的session可以出现在任何地方，例如service,dao等，不需要从controller中传递session参数，用户保存在session中的数据可以在httpsession中获取，保存在httpsession中的数据也可以从session中获取。在使用默认session管理器的情况下，操作session都是等价于操作HttpSession。<br>单点登录的支持：shiro session基于普通java对象，使得它更容易存储和共享，可以实现跨应用程序共享。可以根据共享的会话，来保证认证状态到另一个程序。从而实现单点登录。</p>
<ul>
<li><p>session的作用是什么？</p>
<blockquote>
<p>和web容器中的session作用一样，就是用于记录浏览器和服务器之间的交互</p>
</blockquote>
</li>
<li><p>登录状态和session有没有关系？</p>
<blockquote>
<p>登录认证成功之后，shiro是将认证信息存储在session中的，以后的每次请求肯定会在过滤器中判断session中有没有认证信息，以作为放行的依据。</p>
</blockquote>
</li>
<li><p>为什么要把session持久化，即为sessionDao？是为了分布情况下共享session吗？</p>
<blockquote>
<p>web服务器通常将那些暂时不活动但未超时的HttpSession对象转移到文件系统或数据库中保存，服务器要使用他们时再将他们从文件系统或数据库中装载入内存，这种技术称为Session的持久化。<br>把session持久化的原因有多个，分布式情况下共享session应该是原因之一：</p>
<ol>
<li>提高服务器内存的利用率，保证那些暂停活动的客户端在会话超时之前可以继续原来的会话。</li>
<li>在多台web服务器协同对外提供服务的集群系统中，使用Session的持久化技术，某台服务器可以将其中发生改变的Session对象复制给其他服务器。保证了在某台服务器停止工作后可以由其他服务器来接替它与客户端的会话。</li>
<li>在一个web应用程序重启时，服务器也会持久化该应用程序中所有HttpSession对象，保证客户端的会话活动仍可以继续。</li>
</ol>
</blockquote>
</li>
<li><p>sessionManager可以设置cacheManager？sessionDao也可以设置CacheManager？</p>
<blockquote>
<p>通过查看源码发现：给sessionManager设置的CacheManager最终还是供sessionDao使用，目的就是持久化session到缓存中。</p>
</blockquote>
</li>
<li><p>Shiro提供了Session的支持，主要用途是在Service层获取到Handler层的Session的信息，推荐在Handler层使用HttpSession。</p>
<blockquote>
<p>实际上httpSession和ShiroSession是一样的，主要受SessionManager的控制。</p>
</blockquote>
</li>
<li><p>会话验证调度器是什么？</p>
<blockquote>
<p>默认是开启的，用来验证session的是否过期</p>
</blockquote>
</li>
<li><p>session的有效期可以设置，如果session被sessionDao存储了，那么到达有效期时，是不是也会被删除？</p>
<blockquote>
<p>是的，sessionDao持久化session是有原因的，所以到了有效期，也是会删除session的。</p>
</blockquote>
</li>
<li><p>在用户未退出登录的情况下，关闭浏览器，然后再重新打开一个浏览器去访问系统，为什么展示的就是登录页面？</p>
<blockquote>
<p>关闭了浏览器，cookie失效了，重新打开一个浏览器访问系统时，是没有带着cookie的，所以服务器会认为这是一个全新的访问者，会创建一个全新的session为这次请求服务，上次的session就坐等失效。</p>
</blockquote>
</li>
</ul>
<h2 id="session实现"><a href="#session实现" class="headerlink" title="session实现"></a>session实现</h2><ol>
<li>浏览器端第一次发送请求到服务器端，服务器端创建一个Session，同时会创建一个特殊的Cookie（name为JSESSIONID的固定值，value为session对象的ID），然后将该Cookie发送至浏览器端。</li>
<li>浏览器端发送第N（N&gt;1）次请求到服务器端,浏览器端访问服务器端时就会携带该name为JSESSIONID的Cookie对象。</li>
<li>服务器端根据name为JSESSIONID的Cookie的value(sessionId),去查询Session对象，从而区分不同用户。</li>
</ol>
<h2 id="RememberMe-Cookie"><a href="#RememberMe-Cookie" class="headerlink" title="RememberMe Cookie"></a>RememberMe Cookie</h2><p>当浏览一个网站的时候，网站返回给你一个Session Cookie和一个RememberMe Cookie，Session Cookie很好理解，就是为了此次的对话，一旦关闭了浏览器或者超时了Session Cookie就没用了。但是RememberMe Cookie不太一样，Shiro默认的RememberMe Cookie的时长是一年，所以不用担心这个Cookie的情况。RememberMe Cookie实际就是Shiro把这个用户的信息加密一下放到cookie里面，下次就可以根据这个cookie来进行判断这是哪个用户。</p>
<p>shiro+redis集成，避免每次访问有权限的链接都会去执行MyShiroRealm.doGetAuthenticationInfo()方法来查询当前用户的权限，因为实际情况中权限是不会经常变的，这样就可以使用redis进行权限的缓存。</p>
<p>在ShiroConfig中有代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">       <span class="comment">//设置realm.</span></span><br><span class="line">       securityManager.setRealm(myShiroRealm());</span><br><span class="line">       <span class="comment">// 自定义缓存实现 使用redis</span></span><br><span class="line">       securityManager.setCacheManager(cacheManager());</span><br><span class="line">       <span class="comment">// 自定义session管理 使用redis</span></span><br><span class="line">       securityManager.setSessionManager(sessionManager());</span><br><span class="line">       <span class="keyword">return</span> securityManager;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>使用 shiro-redis 自定义session管理:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.crazycake<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2.1-RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br></pre></td></tr></table></figure>
<p>然后再配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 配置shiro redisManager</span></span><br><span class="line"><span class="comment">    * 使用的是shiro-redis开源插件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> RedisManager <span class="title function_">redisManager</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">RedisManager</span> <span class="variable">redisManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisManager</span>();</span><br><span class="line">       redisManager.setHost(host);</span><br><span class="line">       redisManager.setPort(port);</span><br><span class="line">       redisManager.setExpire(<span class="number">1800</span>);<span class="comment">// 配置缓存过期时间</span></span><br><span class="line">       redisManager.setTimeout(timeout);</span><br><span class="line">       <span class="comment">// redisManager.setPassword(password);</span></span><br><span class="line">       <span class="keyword">return</span> redisManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * cacheManager 缓存 redis实现</span></span><br><span class="line"><span class="comment">    * 使用的是shiro-redis开源插件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> RedisCacheManager <span class="title function_">cacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">RedisCacheManager</span> <span class="variable">redisCacheManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisCacheManager</span>();</span><br><span class="line">       redisCacheManager.setRedisManager(redisManager());</span><br><span class="line">       <span class="keyword">return</span> redisCacheManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * RedisSessionDAO shiro sessionDao层的实现 通过redis</span></span><br><span class="line"><span class="comment">    * 使用的是shiro-redis开源插件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> RedisSessionDAO <span class="title function_">redisSessionDAO</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">RedisSessionDAO</span> <span class="variable">redisSessionDAO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisSessionDAO</span>();</span><br><span class="line">       redisSessionDAO.setRedisManager(redisManager());</span><br><span class="line">       <span class="keyword">return</span> redisSessionDAO;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * shiro session的管理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> DefaultWebSessionManager <span class="title function_">sessionManager</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">DefaultWebSessionManager</span> <span class="variable">sessionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSessionManager</span>();</span><br><span class="line">       sessionManager.setSessionDAO(redisSessionDAO());</span><br><span class="line">       <span class="keyword">return</span> sessionManager;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>配置文件 application.properties中加入：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis</span></span><br><span class="line"><span class="comment"># Redis服务器地址</span></span><br><span class="line"><span class="string">spring.redis.host=</span> <span class="string">localhost</span></span><br><span class="line"><span class="comment"># Redis服务器连接端口</span></span><br><span class="line"><span class="string">spring.redis.port=</span> <span class="number">6379</span></span><br><span class="line"><span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line"><span class="string">spring.redis.pool.max-idle=</span> <span class="number">8</span></span><br><span class="line"><span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line"><span class="string">spring.redis.pool.min-idle=</span> <span class="number">0</span></span><br><span class="line"><span class="comment"># 连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line"><span class="string">spring.redis.pool.max-active=</span> <span class="number">8</span></span><br><span class="line"><span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line"><span class="string">spring.redis.pool.max-wait=</span> <span class="number">-1</span></span><br><span class="line"><span class="comment"># 连接超时时间（毫秒）</span></span><br><span class="line"><span class="string">spring.redis.timeout=</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>使用redis还可以实现集群的session共享。</p>
<h1 id="按钮控制"><a href="#按钮控制" class="headerlink" title="按钮控制"></a>按钮控制</h1><p>在前端页面，对按钮进行细粒度权限控制，只需要在按钮上加上<code>shiro:hasPermission</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">shiro:hasPermission</span>=<span class="string">&quot;/users/add&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span>  <span class="attr">onclick</span>=<span class="string">&quot;$(&#x27;#addUser&#x27;).modal();&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-info&quot;</span> &gt;</span>新增<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>




<h1 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h1><h1 id="添加shiro配置"><a href="#添加shiro配置" class="headerlink" title="添加shiro配置"></a>添加shiro配置</h1><p>配置中添加了一个自定义的表单拦截器<code>MyFormAuthenticationFilter</code>，用来处理登录异常信息并通过返回。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shirFilter</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拦截器.</span></span><br><span class="line">        Map&lt;String,String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 配置不会被拦截的链接 顺序判断</span></span><br><span class="line"></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/assets/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/js/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/img/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/layui/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/captcha/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/favicon.ico&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置退出 过滤器,其中的具体的退出代码Shiro已经替我们实现了</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line">        <span class="comment">// &lt;!-- 过滤链定义，从上向下顺序执行，一般将/**放在最为下边 --&gt;:这是一个坑呢，一不小心代码就不好使了;</span></span><br><span class="line">        <span class="comment">// authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问;</span></span><br><span class="line">        <span class="comment">// user:认证通过或者记住了登录状态(remeberMe)则可以通过</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的&quot;/login.jsp&quot;页面</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="comment">// 登录成功后要跳转的链接</span></span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        <span class="comment">//未授权界面;</span></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/403&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//自定义拦截器</span></span><br><span class="line">        Map&lt;String, Filter&gt; filters = shiroFilterFactoryBean.getFilters();</span><br><span class="line">        filters.put(<span class="string">&quot;authc&quot;</span>, <span class="keyword">new</span> <span class="title class_">MyFormAuthenticationFilter</span>());</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身份认证realm; (这个需要自己写，账号密码校验；权限等)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> myShiroRealm</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MyShiroRealm <span class="title function_">myShiroRealm</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MyShiroRealm</span> <span class="variable">myShiroRealm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyShiroRealm</span>();</span><br><span class="line">        <span class="keyword">return</span> myShiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 安全管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> securityManager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span>  <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        securityManager.setRealm(myShiroRealm());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Realm实现"><a href="#Realm实现" class="headerlink" title="Realm实现"></a>Realm实现</h1><p>Shiro从从<code>Realm</code>获取安全数据（如用户、角色、权限），就是说<code>SecurityManager</code>要验证用户身份，那么它需要从<code>Realm</code>获取相应的用户进行比较以确定用户身份是否合法；也需要从<code>Realm</code>得到用户相应的角色&#x2F;权限进行验证用户是否能进行操作；可以把<code>Realm</code>看成<code>DataSource</code>，即安全数据源。  </p>
<p>Realm主要有两个方法：</p>
<ul>
<li><code>doGetAuthorizationInfo</code>(获取授权信息)</li>
<li><code>doGetAuthenticationInfo</code>(获取身份验证相关信息)</li>
</ul>
<p>自定义Realm实现:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyShiroRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MyShiroRealm.class);</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ShiroService userInfoService;</span><br><span class="line">    <span class="comment">// 权限授权</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">authorizationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span>  <span class="operator">=</span> (UserInfo)principals.getPrimaryPrincipal();</span><br><span class="line">        <span class="keyword">for</span>(SysRole sysRole : userInfoService.findSysRoleListByUsername(userInfo.getUsername()))&#123;</span><br><span class="line">            authorizationInfo.addRole(sysRole.getRolename());</span><br><span class="line">            logger.info(sysRole.toString());</span><br><span class="line">            <span class="keyword">for</span>(SysPermission sysPermission : userInfoService.findSysPermissionListByRoleId(sysRole.getId()))&#123;</span><br><span class="line">                logger.info(sysPermission.toString());</span><br><span class="line">                authorizationInfo.addStringPermission(sysPermission.getUrl());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主要是用来进行身份认证的，也就是说验证用户输入的账号和密码是否正确。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span></span><br><span class="line">            <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">//获取用户的输入的账号.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String)token.getPrincipal();</span><br><span class="line">        logger.info(<span class="string">&quot;对用户[&#123;&#125;]进行登录验证..验证开始&quot;</span>,username);</span><br><span class="line">        <span class="comment">//通过username从数据库中查找 User对象，如果找到，没找到.</span></span><br><span class="line">        <span class="comment">//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span></span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span>  userInfoService.selectUserInfoByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(userInfo == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 抛出 帐号找不到异常  </span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownAccountException</span>();  </span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(userInfo, userInfo.getPassword(), getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="自定义表单验证"><a href="#自定义表单验证" class="headerlink" title="自定义表单验证"></a>自定义表单验证</h1><p>在这里我们登录采用的是login页面post表单的方式，由于shiro已经内置了基于Form表单的身份验证过滤器<code>FormAuthenticationFilter</code>，如果不自定义会调用这个shiro默认的过滤器。因为需要返回登录失败信息，所以我们需要继承自定义一个表单过滤器，重写<code>setFailureAttribute</code>方法（当登录失败时会通过调用该方法），把登录失败信息写入到<code>request</code>的<code>shiroLoginFailure</code>属性中，由前端页面取出打印。  </p>
<p>表单认证过滤器实现:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFormAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">FormAuthenticationFilter</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MyFormAuthenticationFilter.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写该方法, 判断返回登录信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setFailureAttribute</span><span class="params">(ServletRequest request, AuthenticationException ae)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> ae.getClass().getName();</span><br><span class="line">        String message;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userName</span> <span class="operator">=</span> getUsername(request);</span><br><span class="line">        <span class="keyword">if</span> (UnknownAccountException.class.getName().equals(className)) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;对用户[&#123;&#125;]进行登录验证..验证未通过,未知账户&quot;</span>, userName);</span><br><span class="line">            message = <span class="string">&quot;账户不存在&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (IncorrectCredentialsException.class.getName().equals(className)) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;对用户[&#123;&#125;]进行登录验证..验证未通过,错误的凭证&quot;</span>, userName);</span><br><span class="line">            message = <span class="string">&quot;密码不正确&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(LockedAccountException.class.getName().equals(className)) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;对用户[&#123;&#125;]进行登录验证..验证未通过,账户已锁定&quot;</span>, userName);</span><br><span class="line">            message = <span class="string">&quot;账户已锁定&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(ExcessiveAttemptsException.class.getName().equals(className)) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;对用户[&#123;&#125;]进行登录验证..验证未通过,错误次数过多&quot;</span>, userName);</span><br><span class="line">            message = <span class="string">&quot;用户名或密码错误次数过多，请十分钟后再试&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (AuthenticationException.class.getName().equals(className)) &#123;</span><br><span class="line">            <span class="comment">//通过处理Shiro的运行时AuthenticationException就可以控制用户登录失败或密码错误时的情景</span></span><br><span class="line">            logger.info(<span class="string">&quot;对用户[&#123;&#125;]进行登录验证..验证未通过,未知错误&quot;</span>, userName);</span><br><span class="line">            message = <span class="string">&quot;用户名或密码不正确&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            message = className;</span><br><span class="line">        &#125;</span><br><span class="line">        request.setAttribute(getFailureKeyAttribute(), message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

















































<h1 id="web相关"><a href="#web相关" class="headerlink" title="web相关"></a>web相关</h1><h2 id="登录页面"><a href="#登录页面" class="headerlink" title="登录页面"></a>登录页面</h2><h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><h3 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h3><h2 id="主页面"><a href="#主页面" class="headerlink" title="主页面"></a>主页面</h2><h3 id="controller-1"><a href="#controller-1" class="headerlink" title="controller"></a>controller</h3><h3 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h3><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="登录页面权限测试"><a href="#登录页面权限测试" class="headerlink" title="登录页面权限测试"></a>登录页面权限测试</h2><p>启动后，打开locahost:8080下任意链接由于没登录会跳转到login页面，登录成功后会进入index页面，点击主页面上的退出，则会注销登录并跳转至登录页面。</p>

    </div>

    
    
    
    <div>
    
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

    
    </div>
    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>LiuZhihua
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://shiquheng.github.io/2023/08/03/19-53-00/" title="Springboot-shiro权限管理项目">https://shiquheng.github.io/2023/08/03/19-53-00/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/Springboot/" rel="tag"># Springboot</a>
              <a href="/tags/Shiro/" rel="tag"># Shiro</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/08/02/11-03-41/" rel="prev" title="Springboot学习">
                  <i class="fa fa-chevron-left"></i> Springboot学习
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>
  
  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiuZhihua</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/clicklove.js"></script>
  <script type="text/javascript" src="/js/dynamic_bg.js"></script>
</body>
</html>
